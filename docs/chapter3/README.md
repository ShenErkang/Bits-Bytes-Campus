### **第三章：网络层 - 数据平面**

**🛠 数据报的环球之旅：路由、分片与智能转换**

------

#### 1. 网络层概述

**📌 服务模型演进**

> **虚电路服务的历史** ：
> 早期X.25网络采用面向连接服务，需预先建立路径 ✅ 可靠性保障 ❌ 灵活性不足
> **互联网革命** ：转向无连接模型 → 低成本+灵活适配多样化应用 

**📊 数据报 vs 虚电路对比**

| **特性**   | **数据报服务** | **虚电路服务** |
| ---------- | -------------- | -------------- |
| 连接建立   | 无需预连接     | 必需           |
| 路由灵活性 | 动态路径选择   | 固定路径       |
| 典型协议   | IP             | X.25           |



------

#### 2. 数据平面与控制平面

**🔵 数据平面转发流程**

接收帧 → 解封装至IP层 → 查找转发表 → 排队 → 转发至输出端口

**🛠 转发表查询实验**
假设转发表条目：

目的前缀：203.179.0.0/24 → 输出端口：Port2  
默认路由：0.0.0.0/0 → 输出端口：Port5  

输入数据报目的IP：`203.179.1.100` → 匹配前缀 ✅ 转发至Port2

------

#### 3. 路由器基础

**📌 交换结构类型**

- **共享内存式** ：统一缓存区，易拥塞 ❌ 成本低 ✅
- **纵横式（Crossbar）** ：并行转发 ✅ 高吞吐 ❌ 造价高

**📊 调度算法对比**

| **算法**    | **公平性**     | **适用场景** |
| ----------- | -------------- | ------------ |
| 优先级调度  | 低（VIP优先）  | 实时视频传输 |
| Round Robin | 中等（轮询）   | 普通数据流   |
| WFQ         | 高（权重分配） | 混合流量管理 |



**🛠 WFQ调度计算案例**
队列权重：`视频流:3`、`文件传输:2`、`网页:1`
每循环发送次数：视频3次、文件2次、网页1次 → 带宽按3:2:1分配 ✅

------

#### 4. IP协议核心内容

**🔵 IPv4地址演进**

- **分类编址** ：A类（大网络）、B类（中）、C类（小） → 浪费严重 ❌
- **CIDR革命** ：网络前缀灵活长度 → 地址利用率提升 ✅

**🛠 CIDR计算实战**
给定地址块：`203.179.16.0/20`
可用地址范围：`203.179.16.0 ~ 203.179.31.255`
主机数：`2^(32-20) - 2 = 4094`

------

#### 5. IP数据报分片与重组

**📌 MTU影响案例**

- **以太网MTU** ：`1500字节`
- **卫星链路MTU** ：`5000字节` → 分片需求减少 ✅

**🛠 分片计算器**
输入参数：

- 总长度：`4500字节`
- MTU：`1500字节`
  计算步骤：

1. 首部占用：`20字节`
2. 数据最大片：`1500 - 20 = 1480字节`
3. 分片数：`ceil(4500 / 1480) = 4片`
   分片结果：

- 片1：`1480`
- 片2：`1480`
- 片3：`1480`
- 片4：`560`

------

#### 6. NAT技术深度解析

**📌 NAT类型对比**

- **基础NAT** ：一对一地址映射 → 适用少量主机
- **NAPT（端口转换）** ：多主机共享同一IP + 不同端口 ✅ 主流方案

**🔵 NAPT配置案例**

全球IP：203.179.1.1  
本地主机：  
- 192.168.1.101 → 映射端口：203.179.1.1:8080  
- 192.168.1.102 → 映射端口：203.179.1.1:8081  

外部访问`203.179.1.1:8080` → 路由至`192.168.1.101` ✅

------

#### 7. IPv6革新

**📌 IPv6地址类型详解**

- **单播（Unicast）** ：一对一传输（主流类型）
- **多播（Multicast）** ：一组设备接收
- **任播（Anycast）** ：最近节点响应（DNS优化）

**🛠 IPv6地址缩写规则**
原始地址：`2001:0db8:0000:0000:85a3:0000:0000:0001`
缩写后：`2001:0db8::85a3::1` ✅（连续零块省略）

**📊 IPv4 vs IPv6对比**

| **特性**   | **IPv4**     | **IPv6**       |
| ---------- | ------------ | -------------- |
| 地址长度   | 32位         | 128位          |
| 首部复杂度 | 可变选项字段 | 固定+扩展首部  |
| NAT依赖    | 高           | 低（地址充足） |

------

#### 8. 现代数据平面挑战

**📌 云计算影响**

- **虚拟路由器** ：软件定义转发 → 弹性扩展 ✅
- **边缘计算** ：本地数据处理 → 减少核心网络负载 ✅

**🔵 SDN转发案例**

sdn-controller> define-flow src=WebServer dest=Client priority=high  
sdn-controller> apply-network-wide  

效果：全网优先传输Web流量 ✅

------

**💻 章节测试题**
**Q1** ：CIDR地址块`203.179.16.0/20`包含多少主机？
答案：`4094` ✅

**Q2** ：IPv6地址`2001:0db8::85a3::1`是否合法？
答案：是 ✅（连续零缩写正确）

**Q3** ：NAPT如何区分同一IP的多主机？
答案：通过端口号映射 ✅
