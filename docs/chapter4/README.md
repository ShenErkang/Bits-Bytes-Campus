### **第四章：网络层 - 控制平面**

**🗺 数据报的导航系统：路由决策与智能控制**

------

#### 1. 网络层控制平面基础

**📌 路由算法的哲学**

> *“最佳路径未必最短”* ：路由选择需权衡速度、成本、拥塞与策略，例如： 
>
> - **金融系统** ：优先低延迟路径（即使成本高）
> - **公共网络** ：选择负载均衡路径（避免拥塞）

**📊 路由算法对比矩阵**

| **算法类型**             | **信息粒度**      | **适用场景** | **经典缺陷**     |
| ------------------------ | ----------------- | ------------ | ---------------- |
| 链路状态（Dijkstra）     | 全局拓扑+链路成本 | 大型企业网络 | 高内存消耗       |
| 距离向量（Bellman-Ford） | 局部相邻成本      | 小型自治系统 | 慢收敛、路由震荡 |

**🛠 Dijkstra算法实战**
假设网络拓扑：

A → B（成本2）  
A → C（成本5）  
B → D（成本3）  
C → D（成本4）  

计算A到D的最小成本路径：

1. A→B（2） → B→D（3） → 总成本：5 ✅
2. A→C（5） → C→D（4） → 总成本：9 ❌

#### 2. 内部网关协议

**🔵 RIP协议深度解析**
**更新机制缺陷案例** ：

- **路由震荡** ：当链路A→B断开时，相邻路由器可能循环通告“距离+1”导致收敛延迟
- **限制场景** ：最大跳数15 → 无法扩展至大型网络

**🛠 OSPF区域划分实验**

1. 定义区域边界：

   ospf(config)> area 0.0.0.1  

2. 路由器分配至区域：

   router1> ospf assign-area 0.0.0.1  

3. 效果：减少洪泛信息量 ✅ 提升大规模网络性能

**📊 OSPF vs RIP对比**

| **特性**     | **OSPF**         | **RIP**          |
| ------------ | ---------------- | ---------------- |
| 信息交换量   | 低频（变化触发） | 高频（固定间隔） |
| 路由计算方式 | 全局拓扑SPF      | 局部迭代距离向量 |
| 适用规模     | 大型网络         | 小型网络         |



------

#### 3. 外部网关协议 BGP

**📌 BGP策略路由案例**
某企业AS需避免通过竞争对手AS传输数据：

- **策略配置** ：bgp(config)> avoid-path AS6543  
- 效果：强制选择替代路径 ✅ 符合商业策略

**🔵 BGP会话建立流程**

1. 打开报文（OPEN）：建立TCP连接
2. 更新报文（UPDATE）：交换AS可达性信息
3. 保活报文（KEEPALIVE）：维持会话活性
4. 通知报文（NOTIFY）：错误处理

**🛠 BGP路由表解析示例**

目标网络：203.179.0.0/24  
路径：AS1 → AS5 → AS9（优先级：★★★）  
策略过滤：排除AS7 ✅  

#### 4. ICMP协议

**📌 ICMP差错报告层级**

- **终点不可达** ：路由失败或主机离线
- **时间超过** ：TTL耗尽 → Traceroute利用此机制
- **参数问题** ：IP首部错误（如校验和失败）

**🔵 ICMP重定向实验**

1. 主机发送数据至旧网关：`192.168.1.1`
2. 路由器回复ICMP重定向报文 → 新网关：`203.179.1.1`
3. 主机更新路由表 ✅ 后续数据流向新网关

**🛠 PING命令底层流程**

主机A → ICMP回送请求（Echo Request） → 主机B  
主机B → ICMP回送应答（Echo Reply） → 主机A  
时延计算：RTT = 接收时间 - 发送时间  

#### 5. MPLS技术

**📌 标记交换路径（LSP）建立步骤**

1. **标记分配协议（LDP）** ：LSR交换报文确定路径
2. **入口LSR** ：打标记（如`标记值=101`）并初始化转发表
3. **中间LSR** ：根据标记转发+更换新标记
4. **出口LSR** ：去除标记，交付至传统IP网络

**🔵 MPLS转发等价类（FEC）案例**

- **FEC划分依据** ：源IP前缀、目的IP、端口组合
- **负载平衡效果** ：相同FEC分组多路径传输 ✅ 避免拥塞

**🛠 MPLS首部字段解析**

| **字段** | **长度** | **功能**     |
| -------- | -------- | ------------ |
| 标记值   | 20 bits  | 标识转发路径 |
| 栈S      | 1 bit    | 标记嵌套支持 |
| TTL      | 8 bits   | 防止无限循环 |

------

#### 6. 现代控制平面演进

**📌 软件定义网络（SDN）对比**

| **特性**     | **传统路由** | **SDN**          |
| ------------ | ------------ | ---------------- |
| 控制中心     | 分布式       | 集中化（控制器） |
| 路由更新速度 | 慢（逐节点） | 快（全局推送）   |
| 灵活性       | 低           | 高（可编程）     |

**🛠 SDN控制器配置示例**

sdn-controller> define-path src=A dest=D cost=low  
sdn-controller> push-flowtable all-routers  

效果：全网路由表即时更新 ✅

------

**💻 章节测试题**
**Q1** ：BGP协议的主要功能是？
A) 计算最短路径
B) 交换网络可达性与策略路由
答案：B ✅

**Q2** ：MPLS标记值在哪个字段中存储？
A) IP首部
B) 专用MPLS首部
答案：B ✅

**Q3** ：ICMP时间超过报文由哪种情况触发？
A) TTL降至0
B) 传输时延超过阈值
答案：A ✅
